<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>MediaMatch</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="./static/assets/css/essential.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="./static/assets/css/style.css">
    <link href="https://uploads-ssl.webflow.com/63a4d61127f93641d7ae56a7/63b878ca4b43c75ee8c6b487_icon-32.png" rel="shortcut icon" type="image/x-icon">
    <link href="https://uploads-ssl.webflow.com/63a4d61127f93641d7ae56a7/63b878cce27f73545d106479_icon-256.png" rel="apple-touch-icon">
    <link rel="stylesheet" href="./static/assets/css/swiper-bundle.min.css">
    <link rel="stylesheet" href="./static/assets/css/popup.css">
    <style>
      .filter-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
        margin-bottom: 20px;
      }
      .filter-option {
        position: relative;
        display: inline-block;
      }
      .filter-option input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
      }
      .filter-option label {
        display: inline-block;
        padding: 8px 16px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .filter-option input[type="radio"]:checked + label {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 1);
        color: white;
      }
      .filter-option label:hover {
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.8);
        color: white;
      }
      .match-term {
        display: inline-block;
        margin: 4px;
        padding: 6px 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        font-size: 14px;
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        line-height: 1.4;
      }
      .description-truncated {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 5px;
      }
      .description-full {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        line-height: 1.5;
        display: none;
      }
      .show-more-less {
        color: rgba(255, 255, 255, 0.6);
        text-decoration: underline;
        font-size: 12px;
        cursor: pointer;
      }
      .media-card {
        position: relative;
        transition: transform 0.3s ease;
      }
      .media-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }
      .explanation-section {
        margin-top: 40px;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .loading-indicator {
        color: rgba(255, 255, 255, 0.7);
        font-style: italic;
      }
    </style>
  </head>
  <body class="dark-theme">
    <div class="page-wrapper">
      <div class="sec h-hero-sec">
        <div class="nav">
          <div class="container nav-container">
            <a>
              <div class="brand-logo w-embed">
                <svg id="esUqO4CI2Ku1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 54 54" fill="currentColor" shape-rendering="geometricPrecision" text-rendering="geometricPrecision">
                  </g>
                </svg>
              </div>
          </div>
        </div>
        <div class="sec">
          <div class="container">
            <div class="h-hero-header">
              <h1 class="f-100">It's time to turn your</h1>
              <div id="hero-anim" class="h-hero-header-highlight-wrapper">
                <div class="h-hero-header-highlight">
                  <div class="hero-highlight-wrapper left-1" style="display: none; width: 0px;">
                    <div class="hero-highlight">
                      <h1 class="f-100 f-white">ideas</h1>
                    </div>
                  </div>
                  <div class="hero-highlight-wrapper left-2" style="display: none; width: 0px;">
                    <div class="hero-highlight left-2">
                      <h1 class="f-100 f-white">thoughts</h1>
                    </div>
                  </div>
                </div>
                <div class="h-hero-header-highlight-w">
                  <div class="h-hero-header-arrow w-embed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" fill="currentColor" viewBox="0 0 73 38">
                      <path fill-rule="evenodd" d="m70.02 16.175 2.972 2.972-2.972 2.971-15.85 15.85-2.97-2.972 13.747-13.748H.817v-4.203h64.13L51.199 3.298 54.171.326l15.849 15.85Z" clip-rule="evenodd"></path>
                    </svg>
                  </div>
                  <div class="h-hero-header-highlight">
                    <div class="hero-highlight-wrapper right-1" style="display: none; width: 0px;">
                      <div class="hero-highlight">
                        <h1 class="f-100 f-white">books</h1>
                      </div>
                    </div>
                    <div class="hero-highlight-wrapper right-2" style="display: block; width: auto;">
                      <div class="hero-highlight left-2">
                        <h1 class="f-100 f-white">movies</h1>
                      </div>
                    </div>
                    <div class="hero-highlight-wrapper right-3" style="display: none; width: 0px;">
                      <div class="hero-highlight left-3">
                        <h1 class="f-100 f-white">games</h1>
                      </div>
                    </div>
                    <div class="hero-highlight-wrapper right-4" style="display: none; width: 0px;">
                      <div class="hero-highlight left-4">
                        <h1 class="f-100 f-white">shows</h1>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <h1 class="f-100">with MediaMatch.</h1>
            <div class="h-hero-p">
                <p class="f-30">Discover your next favorite stories across all media with personalized recommendations.</p>
                <br>
                <p>*Based on your unique preferences.</p>
                <div class="input-wrapper" style="margin-top: 30px; margin-bottom: 30px;">
                    <form action="/search" method="post">
                      <textarea 
                        placeholder="Enter a synopsis to discover similar content..." 
                        style="width: 100%; 
                        padding: 18px; 
                        border-radius: 0px; /* Square corners */
                        background-color: rgba(255, 255, 255, 0.03); 
                        border: 2px solid rgba(255, 255, 255, 0.7); /* White outline */
                        color: #fff;
                        font-size: 16px;
                        min-height: 120px;
                        transition: all 0.3s ease;
                        resize: vertical;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);"
                        onfocus="this.style.borderColor='rgba(255, 255, 255, 1)'; this.style.boxShadow='0 4px 20px rgba(255, 255, 255, 0.15)';" 
                        onblur="this.style.borderColor='rgba(255, 255, 255, 0.7)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.1)';"
                        name="query"></textarea>
                      
                      <div class="filter-group">
                        <p style="width: 100%; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9);">Filter by media type:</p>
                        <div class="filter-option">
                          <input type="radio" id="all" name="media_type" value="all" checked>
                          <label for="all">All Media</label>
                        </div>
                        <div class="filter-option">
                          <input type="radio" id="book" name="media_type" value="book">
                          <label for="book">Books Only</label>
                        </div>
                        <div class="filter-option">
                          <input type="radio" id="movie" name="media_type" value="movie">
                          <label for="movie">Movies Only</label>
                        </div>
                        <div class="filter-option">
                          <input type="radio" id="game" name="media_type" value="game">
                          <label for="game">Games Only</label>
                        </div>
                      </div>
                      
                      <div style="display: flex; justify-content: flex-start; margin-top: 12px;">
                        <button type="submit" 
                        style="padding: 12px 24px; 
                        background-color: transparent; /* Transparent background */
                        color: white; 
                        border: 2px solid rgba(255, 255, 255, 0.7); /* White outline */
                        border-radius: 0px; /* Square corners */
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        float: left;"
                        onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.1)'; this.style.borderColor='rgba(255, 255, 255, 1)';" 
                        onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='rgba(255, 255, 255, 0.7)';">
                        Get Recommendations
                        </button>
                      </div>
                    </form>
                  </div>
               
              </div>
              <div class="h-hero-btn">
          </div>
        </div>
      </div>
      <div class="padding-top padding-120"></div>
      <script src="./static/assets/js/gsap.min.js"></script>
      <script src="./static/assets/js/index.js"></script>
      
      <script>
        // Function to toggle description visibility
        function toggleDescription(element, id) {
          const truncated = document.getElementById(`desc-truncated-${id}`);
          const full = document.getElementById(`desc-full-${id}`);
          
          if (truncated.style.display === 'none') {
            truncated.style.display = 'block';
            full.style.display = 'none';
          } else {
            truncated.style.display = 'none';
            full.style.display = 'block';
          }
        }
        
        // Function to fetch explanation for query
        // Updated fetchQueryExplanation function for SVD dimensions
        function fetchQueryExplanation(query) {
          const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const apiBaseUrl = isLocalhost ? '' : 'http://4300showcase.infosci.cornell.edu:5235/';
          
          // Use the first result (index 0) for the explanation
          fetch(`${isLocalhost ? '' : apiBaseUrl}/explain?id=0&query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(explanation => {
              const tagsContainer = document.getElementById('explanation-tags');
              
              // Clear loading indicator
              tagsContainer.innerHTML = '';
              
              if (explanation.svd_dimensions && explanation.svd_dimensions.length > 0) {
                // Create a container for SVD dimensions
                const dimensionsContainer = document.createElement('div');
                dimensionsContainer.className = 'svd-dimensions';
                dimensionsContainer.style.width = '100%';
                
                explanation.svd_dimensions.forEach(dimension => {
                  // Create a dimension card
                  const dimensionCard = document.createElement('div');
                  dimensionCard.className = 'dimension-card';
                  dimensionCard.style.marginBottom = '15px';
                  dimensionCard.style.padding = '10px';
                  dimensionCard.style.backgroundColor = 'rgba(255, 255, 255, 0.07)';
                  dimensionCard.style.borderRadius = '4px';
                  
                  // Create header for dimension
                  const dimensionHeader = document.createElement('div');
                  dimensionHeader.style.marginBottom = '8px';
                  dimensionHeader.style.fontWeight = 'bold';
                  dimensionHeader.textContent = dimension.name;
                  
                  dimensionCard.appendChild(dimensionHeader);
                  
                  // Create terms container
                  const termsContainer = document.createElement('div');
                  termsContainer.style.display = 'flex';
                  termsContainer.style.flexWrap = 'wrap';
                  termsContainer.style.gap = '6px';
                  
                  // Add each term as a tag
                  if (dimension.terms && dimension.terms.length > 0) {
                    dimension.terms.forEach(term => {
                      const termTag = document.createElement('span');
                      termTag.className = 'match-term';
                      
                      // Different styling based on term direction
                      if (term.direction === 'positive') {
                        termTag.style.backgroundColor = 'rgba(100, 255, 100, 0.1)';
                        termTag.style.borderColor = 'rgba(100, 255, 100, 0.3)';
                      } else {
                        termTag.style.backgroundColor = 'rgba(255, 100, 100, 0.1)';
                        termTag.style.borderColor = 'rgba(255, 100, 100, 0.3)';
                      }
                      
                      termTag.textContent = term.term;
                      termsContainer.appendChild(termTag);
                    });
                  }
                  
                  dimensionCard.appendChild(termsContainer);
                  dimensionsContainer.appendChild(dimensionCard);
                });
                
                tagsContainer.appendChild(dimensionsContainer);
              } else if (explanation.tags && explanation.tags.length > 0) {
                // Fallback to regular tags if no SVD dimensions
                explanation.tags.forEach(tag => {
                  const tagElement = document.createElement('span');
                  tagElement.className = 'match-term';
                  tagElement.textContent = tag;
                  tagsContainer.appendChild(tagElement);
                });
              } else {
                tagsContainer.innerHTML = '<p>No specific dimensions found for this query.</p>';
              }
            })
            .catch(error => {
              document.getElementById('explanation-tags').innerHTML = 
                '<p>Error loading explanation.</p>';
            });
        }
      </script>
      
      <!-- pass information script -->
      <script>
      document.addEventListener('DOMContentLoaded', function() {
      const synopsisForm = document.querySelector('form[action="/search"]');
      
      if (synopsisForm) {
        // Update the form action to use the absolute URL if not on localhost
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiBaseUrl = isLocalhost ? '' : 'http://4300showcase.infosci.cornell.edu:5235/'; // Replace with your actual server domain
        
        // Update the form action attribute
        if (!isLocalhost) {
          synopsisForm.action = `${apiBaseUrl}/search`;
        }
        
        synopsisForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const query = document.querySelector('textarea[name="query"]').value;
          
          if (!query) {
            alert('Please enter text to search');
            return;
          }
          
          let loadingIndicator = document.createElement('div');
          loadingIndicator.id = 'loading';
          loadingIndicator.innerHTML = 'Finding recommendations...';
          loadingIndicator.style.color = 'white';
          loadingIndicator.style.marginTop = '15px';
          loadingIndicator.style.fontStyle = 'italic';
          
          let resultsContainer = document.getElementById('results');
          if (!resultsContainer) {
            resultsContainer = document.createElement('div');
            resultsContainer.id = 'results';
            resultsContainer.style.marginTop = '30px';
            synopsisForm.after(resultsContainer);
          } else {
            resultsContainer.innerHTML = '';
          }
          
          synopsisForm.after(loadingIndicator);
          
          const mediaType = document.querySelector('input[name="media_type"]:checked')?.value || 'all';
          
          // Use the correct API URL based on environment
          const searchUrl = isLocalhost ? '/search' : `${apiBaseUrl}/search`;
          
          fetch(searchUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `query=${encodeURIComponent(query)}&media_type=${encodeURIComponent(mediaType)}`,
            credentials: 'include',
            mode: 'cors'
          })
          .then(response => {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return response.json();
            } else {
              return response.text().then(text => {
                console.error('Non-JSON response:', text);
                throw new Error('Server returned non-JSON response. Check the console for details.');
              });
            }
          })
          .then(data => {
            if (document.getElementById('loading')) {
              document.getElementById('loading').remove();
            }
            
            if (data.error) {
              resultsContainer.innerHTML = `<div class="alert-error" style="color: #ff6b6b; padding: 15px; background-color: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); margin-bottom: 15px;">${data.error}</div>`;
              return;
            }
            
            if (!data.results || data.results.length === 0) {
              resultsContainer.innerHTML = `<div class="alert-info" style="color: #ffffff; padding: 15px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 15px;">No recommendations found. Try a different search term.</div>`;
              return;
            }
            
            // Add header showing the search and filter
            const resultsHeader = document.createElement('div');
            resultsHeader.innerHTML = `
              <h2 style="color: white; margin-bottom: 10px;">Results for "${query.length > 40 ? query.substring(0, 40) + '...' : query}"</h2>
              <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;">
                Found ${data.results.length} matches ${mediaType !== 'all' ? `(${mediaType}s only)` : 'across all media'}
              </p>
            `;
            resultsContainer.appendChild(resultsHeader);
            
            // Create a grid for results
            const resultsGrid = document.createElement('div');
            resultsGrid.style.display = 'grid';
            resultsGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            resultsGrid.style.gap = '20px';
            resultsGrid.style.marginTop = '20px';
            
            data.results.forEach((result, index) => {
              const card = document.createElement('div');
              card.className = `media-card ${result.media_type || ''}`;
              card.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
              card.style.border = '1px solid rgba(255, 255, 255, 0.1)';
              card.style.padding = '20px';
              
              const score = result.score ? Math.round(result.score * 100) : '?';
              
              // Check if description needs truncation
              const description = result.description || 'No description available';
              const needsTruncation = description.length > 150;
              const shortDesc = needsTruncation ? description.substring(0, 150) + '...' : description;
              
              card.innerHTML = `
                <div class="card-content">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: white; font-size: 18px;">${result.title || 'Untitled'}</h3>
                     <span style="background-color: rgba(255, 255, 255, 0.2); color: white; padding: 4px 8px; font-size: 14px;">${score}% match</span>
                  </div>
                  <h4 style="color: rgba(255, 255, 255, 0.7); font-size: 14px; margin-top: 0; margin-bottom: 10px;">
                    ${result.media_type ? (result.media_type.charAt(0).toUpperCase() + result.media_type.slice(1)) : 'Unknown'} 
                    ${result.genre ? '| ' + result.genre : ''}
                  </h4>
                  
                  <!-- Description with expandable functionality -->
                  <div class="description-container">
                    <p id="desc-truncated-${index}" class="description-truncated">
                      ${shortDesc}
                      ${needsTruncation ? `<span class="show-more-less" onclick="toggleDescription(this, ${index})">Show more</span>` : ''}
                    </p>
                    <p id="desc-full-${index}" class="description-full">
                      ${description}
                      <span class="show-more-less" onclick="toggleDescription(this, ${index})">Show less</span>
                    </p>
                  </div>
                </div>
              `;
              
              resultsGrid.appendChild(card);
            });
            
            resultsContainer.appendChild(resultsGrid);
            
            const explanationSection = document.createElement('div');
            explanationSection.id = 'query-explanation';
            explanationSection.className = 'explanation-section';

            explanationSection.innerHTML = `
              <h3 style="color: white; margin-top: 0;">Why these were recommended:</h3>
              <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px;">
                SVD dimensions that influenced these results:
              </p>
              <div id="explanation-tags" style="display: flex; flex-direction: column; margin-bottom: 20px;">
                <div class="loading-indicator">Loading...</div>
              </div>
            `;

            resultsContainer.appendChild(explanationSection);

            // Fetch explanation data for the query
            fetchQueryExplanation(query);
          })
          .catch(error => {
            console.error('Error details:', error);
            
            if (document.getElementById('loading')) {
              document.getElementById('loading').remove();
            }
            
            resultsContainer.innerHTML = `
              <div class="alert-error" style="color: #ff6b6b; padding: 15px; background-color: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); margin-bottom: 15px;">
                <p><strong>Error:</strong> ${error.message || 'An unknown error occurred'}</p>
                <p>This could happen if:</p>
                <ul style="margin-left: 20px; margin-top: 5px;">
                  <li>The server is not accessible from your current domain (CORS issue)</li>
                  <li>The server is down or unreachable</li>
                  <li>The endpoint URL is incorrect</li>
                  <li>The server is returning HTML instead of JSON</li>
                  <li>There's a server-side error in processing your request</li>
                </ul>
                <p>Check the browser console (F12) for more detailed error information.</p>
              </div>
            `;
          });
        });
      } else {
        console.error('Form with action="/search" not found on page');
      }
    });
    </script>
  </body>
</html>